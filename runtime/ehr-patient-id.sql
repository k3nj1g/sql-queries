SELECT ROW_TO_JSON("patient_subselect".*) AS "patient"
FROM (
              SELECT "patient"."id" AS "id",
                     "patient"."resource_type" AS "resource_type",
                     "patient"."status" AS "status",
                     "patient"."cts" AS "cts",
                     "patient"."ts" AS "ts",
                     "patient"."txid" AS "txid",
                     (
                            "patient".resource || JSONB_BUILD_OBJECT(
                                   'id',
                                   "patient".id,
                                   'resourceType',
                                   "patient".resource_type
                            )
                     ) AS "resource",
                     (
                            SELECT JSON_AGG(ROW_TO_JSON("encounter_subselect".*)) AS "encounter"
                            FROM (
                                          SELECT "encounter"."id" AS "id",
                                                 "encounter"."resource_type" AS "resource_type",
                                                 "encounter"."status" AS "status",
                                                 "encounter"."cts" AS "cts",
                                                 "encounter"."ts" AS "ts",
                                                 "encounter"."txid" AS "txid",
                                                 (
                                                        "encounter".resource || JSONB_BUILD_OBJECT(
                                                               'id',
                                                               "encounter".id,
                                                               'resourceType',
                                                               "encounter".resource_type
                                                        )
                                                 ) AS "resource"
                                          FROM "encounter"
                                          WHERE (
                                                        (
                                                               (
                                                                      SELECT mkb
                                                                      FROM UNNEST(
                                                                                    knife_extract_text (
                                                                                           encounter.resource,
                                                                                           '[["contained",{},"code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
                                                                                    )
                                                                             ) mkb
                                                                      WHERE mkb SIMILAR TO 'F%'
                                                                             OR mkb SIMILAR TO 'F1%'
                                                                             OR mkb SIMILAR TO '(B2[0-4])%'
                                                                             OR mkb SIMILAR TO '(A5[0-469]|A6[03]|Z22.[48]|Z11.3|Z71.2|Z86.1|Z20.2|N89|N34.1|B37.3|B37.4)%'
                                                                             OR mkb SIMILAR TO '(A1[5-9]|B90|R76.1|Z20.1)%'
                                                                      LIMIT 1
                                                               ) IS NULL
                                                               AND "encounter"."resource" @@ logic_revinclude(
                                                                      "patient"."resource",
                                                                      "patient"."id",
                                                                      'subject',
                                                                      ' and not status="entered-in-error"'
                                                               )
                                                               AND in_period_matched_identifier(
                                                                      "encounter"."cts",
                                                                      "encounter"."resource",
                                                                      "patient"."resource",
                                                                      'subject'
                                                               )
                                                               AND (
                                                                      (
                                                                             SELECT "id"
                                                                             FROM "episodeofcare" "eoc"
                                                                             WHERE (
                                                                                           (
--                                                                                                  "eoc"."resource" @@ logic_include("encounter"."resource", 'episodeOfCare[*]')
                                                                                                  "eoc"."id" = ANY (
                                                                                                         ARRAY (
                                                                                                                (
                                                                                                                       SELECT JSONB_PATH_QUERY("encounter"."resource", '$.episodeOfCare[*].id')#>>'{}'
                                                                                                                )
                                                                                                         )
                                                                                                  )
                                                                                           )
                                                                                           AND "eoc"."resource" @@ 'type.#.coding.#(system="urn:CodeSystem:episodeofcare-type" and code="RegCOVID19")'::jsquery
                                                                                    )
                                                                             LIMIT 1
                                                                      ) IS NULL
                                                                      OR "encounter"."resource"->>'contained' IS NOT NULL
                                                               )
                                                        )
                                                        AND LOWER("patient"."resource"#>>'{name,0,given,0}') = CASE
                                                               WHEN "encounter"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
                                                                      SPLIT_PART(
                                                                             SPLIT_PART(
                                                                                    "encounter"."resource"#>>'{subject,display}',
                                                                                    ',',
                                                                                    1
                                                                             ),
                                                                             ' ',
                                                                             2
                                                                      )
                                                               )
                                                               ELSE LOWER("patient"."resource"#>>'{name,0,given,0}')
                                                        END
                                                        AND COALESCE(
                                                               LOWER("patient"."resource"#>>'{name,0,given,1}'),
                                                               ''
                                                        ) = CASE
                                                               WHEN "encounter"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
                                                                      SPLIT_PART(
                                                                             SPLIT_PART(
                                                                                    "encounter"."resource"#>>'{subject,display}',
                                                                                    ',',
                                                                                    1
                                                                             ),
                                                                             ' ',
                                                                             3
                                                                      )
                                                               )
                                                               ELSE COALESCE(
                                                                      LOWER("patient"."resource"#>>'{name,0,given,1}'),
                                                                      ''
                                                               )
                                                        END
                                                        AND CAST("patient"."resource"->>'birthDate' AS "date") = CASE
                                                               WHEN "encounter"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN TO_DATE(
                                                                      SPLIT_PART(
                                                                             "encounter"."resource"#>>'{subject,display}',
                                                                             ',',
                                                                             2
                                                                      ),
                                                                      'DD.mm.YYYY'
                                                               )
                                                               ELSE CAST("patient"."resource"->>'birthDate' AS "date")
                                                        END
                                                 )
                                          ORDER BY CAST(
                                                        "encounter"."resource"#>>'{period,start}' AS "timestamptz"
                                                 ) DESC NULLS FIRST
                                          LIMIT 1
                                   ) "encounter_subselect"
                     ) AS "encounter"
--                     (
--                            SELECT JSON_AGG(ROW_TO_JSON("documentreference_subselect".*)) AS "documentreference"
--                            FROM (
--                                          SELECT "documentreference"."id" AS "id",
--                                                 "documentreference"."resource_type" AS "resource_type",
--                                                 "documentreference"."status" AS "status",
--                                                 "documentreference"."cts" AS "cts",
--                                                 "documentreference"."ts" AS "ts",
--                                                 "documentreference"."txid" AS "txid",
--                                                 (
--                                                        "documentreference".resource || JSONB_BUILD_OBJECT(
--                                                               'id',
--                                                               "documentreference".id,
--                                                               'resourceType',
--                                                               "documentreference".resource_type
--                                                        )
--                                                 ) AS "resource"
--                                          FROM "documentreference"
--                                          WHERE (
--                                                        (
--                                                               (
--                                                                      "documentreference"."resource" @@ logic_revinclude("patient"."resource", "patient"."id", 'subject')
--                                                                      AND in_period_matched_identifier(
--                                                                             "documentreference"."cts",
--                                                                             "documentreference"."resource",
--                                                                             "patient"."resource",
--                                                                             'subject'
--                                                                      )
--                                                               )
--                                                               AND LOWER("patient"."resource"#>>'{name,0,given,0}') = CASE
--                                                                      WHEN "documentreference"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                                             SPLIT_PART(
--                                                                                    SPLIT_PART(
--                                                                                           "documentreference"."resource"#>>'{subject,display}',
--                                                                                           ',',
--                                                                                           1
--                                                                                    ),
--                                                                                    ' ',
--                                                                                    2
--                                                                             )
--                                                                      )
--                                                                      ELSE LOWER("patient"."resource"#>>'{name,0,given,0}')
--                                                               END
--                                                               AND COALESCE(
--                                                                      LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                                      ''
--                                                               ) = CASE
--                                                                      WHEN "documentreference"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                                             SPLIT_PART(
--                                                                                    SPLIT_PART(
--                                                                                           "documentreference"."resource"#>>'{subject,display}',
--                                                                                           ',',
--                                                                                           1
--                                                                                    ),
--                                                                                    ' ',
--                                                                                    3
--                                                                             )
--                                                                      )
--                                                                      ELSE COALESCE(
--                                                                             LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                                             ''
--                                                                      )
--                                                               END
--                                                               AND CAST("patient"."resource"->>'birthDate' AS "date") = CASE
--                                                                      WHEN "documentreference"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN TO_DATE(
--                                                                             SPLIT_PART(
--                                                                                    "documentreference"."resource"#>>'{subject,display}',
--                                                                                    ',',
--                                                                                    2
--                                                                             ),
--                                                                             'DD.mm.YYYY'
--                                                                      )
--                                                                      ELSE CAST("patient"."resource"->>'birthDate' AS "date")
--                                                               END
--                                                        )
--                                                        AND "documentreference"."resource" @@ 'not status in ("draft","entered-in-error") and category.#.coding.#(system="urn:CodeSystem:medrecord-type" and code in ("result-mse","referral-mse","return-mse"))'::jsquery
--                                                        AND (
--                                                               SELECT mkb
--                                                               FROM UNNEST(
--                                                                             knife_extract_text (
--                                                                                    documentreference.resource,
--                                                                                    '[["extension",{"url":"urn:extension:diagnosis"},"extension",{"url":"mkb"},"valueCodeableConcept","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
--                                                                             )
--                                                                      ) mkb
--                                                               WHERE mkb SIMILAR TO 'F%'
--                                                                      OR mkb SIMILAR TO 'F1%'
--                                                                      OR mkb SIMILAR TO '(B2[0-4])%'
--                                                                      OR mkb SIMILAR TO '(A5[0-469]|A6[03]|Z22.[48]|Z11.3|Z71.2|Z86.1|Z20.2|N89|N34.1|B37.3|B37.4)%'
--                                                                      OR mkb SIMILAR TO '(A1[5-9]|B90|R76.1|Z20.1)%'
--                                                               LIMIT 1
--                                                        ) IS NULL
--                                                 )
--                                          ORDER BY CAST(
--                                                        "documentreference"."resource"->>'date' AS "timestamptz"
--                                                 ) DESC NULLS LAST
--                                          LIMIT 1
--                                   ) "documentreference_subselect"
--                     ) AS "mse"
--                     (
--                            SELECT JSON_AGG(ROW_TO_JSON("medicationrequest_subselect".*)) AS "medicationrequest"
--                            FROM (
--                                          SELECT "medicationrequest"."id" AS "id",
--                                                 "medicationrequest"."resource_type" AS "resource_type",
--                                                 "medicationrequest"."status" AS "status",
--                                                 "medicationrequest"."cts" AS "cts",
--                                                 "medicationrequest"."ts" AS "ts",
--                                                 "medicationrequest"."txid" AS "txid",
--                                                 (
--                                                        "medicationrequest".resource || JSONB_BUILD_OBJECT(
--                                                               'id',
--                                                               "medicationrequest".id,
--                                                               'resourceType',
--                                                               "medicationrequest".resource_type
--                                                        )
--                                                 ) AS "resource",
--                                                 (
--                                                        SELECT ROW_TO_JSON("concept_subselect".*) AS "concept"
--                                                        FROM (
--                                                                      SELECT "concept"."id" AS "id",
--                                                                             "concept"."resource_type" AS "resource_type",
--                                                                             "concept"."status" AS "status",
--                                                                             "concept"."cts" AS "cts",
--                                                                             "concept"."ts" AS "ts",
--                                                                             "concept"."txid" AS "txid",
--                                                                             (
--                                                                                    "concept".resource || JSONB_BUILD_OBJECT(
--                                                                                           'id',
--                                                                                           "concept".id,
--                                                                                           'resourceType',
--                                                                                           "concept".resource_type
--                                                                                    )
--                                                                             ) AS "resource"
--                                                                      FROM "concept" "concept"
--                                                                      WHERE (
--                                                                                    "concept"."resource"#>>'{system}' = 'urn:CodeSystem:mz.smnn.esklp'
--                                                                                    AND "concept"."resource" @@ CAST(
--                                                                                           concat(
--                                                                                                  'property.SMNN_CODE = "',
--                                                                                                  JSONB_PATH_QUERY_FIRST(
--                                                                                                         "medicationrequest"."resource",
--                                                                                                         '$.medication.CodeableConcept.coding[*] ? (@.system == "urn:CodeSystem:rmis.klp").code'
--                                                                                                  )#>>'{}',
--                                                                                                  '"'
--                                                                                           ) AS "jsquery"
--                                                                                    )
--                                                                             )
--                                                                      LIMIT 1
--                                                               ) "concept_subselect"
--                                                 ) AS "smnn_node",
--                                                 (
--                                                        SELECT ROW_TO_JSON("concept_subselect".*) AS "concept"
--                                                        FROM (
--                                                                      SELECT "concept"."id" AS "id",
--                                                                             "concept"."resource_type" AS "resource_type",
--                                                                             "concept"."status" AS "status",
--                                                                             "concept"."cts" AS "cts",
--                                                                             "concept"."ts" AS "ts",
--                                                                             "concept"."txid" AS "txid",
--                                                                             (
--                                                                                    "concept".resource || JSONB_BUILD_OBJECT(
--                                                                                           'id',
--                                                                                           "concept".id,
--                                                                                           'resourceType',
--                                                                                           "concept".resource_type
--                                                                                    )
--                                                                             ) AS "resource"
--                                                                      FROM "concept" "concept"
--                                                                      WHERE (
--                                                                                    "concept"."resource"#>>'{system}' = 'urn:CodeSystem:mz.specialized-nutrition'
--                                                                                    AND "concept"."resource"#>>'{code}' = JSONB_PATH_QUERY_FIRST(
--                                                                                           "medicationrequest"."resource",
--                                                                                           '$.medication.CodeableConcept.coding[*] ? (@.system == "urn:CodeSystem:rmis.health").code'
--                                                                                    )#>>'{}'
--                                                                             )
--                                                                      LIMIT 1
--                                                               ) "concept_subselect"
--                                                 ) AS "specialized_nutrition",
--                                                 (
--                                                        SELECT ROW_TO_JSON("concept_subselect".*) AS "concept"
--                                                        FROM (
--                                                                      SELECT "concept"."id" AS "id",
--                                                                             "concept"."resource_type" AS "resource_type",
--                                                                             "concept"."status" AS "status",
--                                                                             "concept"."cts" AS "cts",
--                                                                             "concept"."ts" AS "ts",
--                                                                             "concept"."txid" AS "txid",
--                                                                             (
--                                                                                    "concept".resource || JSONB_BUILD_OBJECT(
--                                                                                           'id',
--                                                                                           "concept".id,
--                                                                                           'resourceType',
--                                                                                           "concept".resource_type
--                                                                                    )
--                                                                             ) AS "resource"
--                                                                      FROM "concept" "concept"
--                                                                      WHERE (
--                                                                                    "concept"."resource"#>>'{system}' = 'urn:CodeSystem:mz.medical-devices'
--                                                                                    AND "concept"."resource"#>>'{code}' = JSONB_PATH_QUERY_FIRST(
--                                                                                           "medicationrequest"."resource",
--                                                                                           '$.medication.CodeableConcept.coding[*] ? (@.system == "urn:CodeSystem:rmis.medicament").code'
--                                                                                    )#>>'{}'
--                                                                             )
--                                                                      LIMIT 1
--                                                               ) "concept_subselect"
--                                                 ) AS "medical_devices"
--                                          FROM "medicationrequest"
--                                          WHERE (
--                                                        "medicationrequest"."resource" @@ logic_revinclude("patient"."resource", "patient"."id", 'subject')
--                                                        AND in_period_matched_identifier(
--                                                               "medicationrequest"."cts",
--                                                               "medicationrequest"."resource",
--                                                               "patient"."resource",
--                                                               'subject'
--                                                        )
--                                                        AND CAST(
--                                                               "medicationrequest"."resource"#>>'{dispenseRequest,validityPeriod,end}' AS "date"
--                                                        ) >= CURRENT_DATE
--                                                 )
--                                          ORDER BY medicationrequest.resource->>'authoredOn' DESC NULLS LAST
--                                          LIMIT 1
--                                   ) "medicationrequest_subselect"
--                     ) AS "medicationRequest"
--                     (
--                            WITH "patient_docs" AS (
--                                   SELECT *
--                                   FROM "documentreference"
--                                   WHERE (
--                                                 (
--                                                        "documentreference"."resource" @@ logic_revinclude(
--                                                               "patient"."resource",
--                                                               "patient"."id",
--                                                               'subject',
--                                                               ' and not status in ("superseded","entered-in-error") and not docStatus in ("superseded","preliminary") and not medicalReport.impossibleReason=* and not category.#.coding.#(code in ("TMK-service-request-attachment","result-mse","referral-mse","deathCertificate","documenttoREMD","birth-certificate"))'
--                                                        )
--                                                        AND in_period_matched_identifier(
--                                                               "documentreference"."cts",
--                                                               "documentreference"."resource",
--                                                               "patient"."resource",
--                                                               'subject'
--                                                        )
--                                                        AND COALESCE(
--                                                               "documentreference"."resource"->>'active',
--                                                               'true'
--                                                        ) = 'true'
--                                                        AND (
--                                                               SELECT mkb
--                                                               FROM UNNEST(
--                                                                             knife_extract_text (
--                                                                                    documentreference.resource,
--                                                                                    '[["extension",{"url":"urn:extension:diagnosis"},"extension",{"url":"mkb"},"valueCodeableConcept","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
--                                                                             )
--                                                                      ) mkb
--                                                               WHERE mkb SIMILAR TO 'F%'
--                                                                      OR mkb SIMILAR TO 'F1%'
--                                                                      OR mkb SIMILAR TO '(B2[0-4])%'
--                                                                      OR mkb SIMILAR TO '(A5[0-469]|A6[03]|Z22.[48]|Z11.3|Z71.2|Z86.1|Z20.2|N89|N34.1|B37.3|B37.4)%'
--                                                                      OR mkb SIMILAR TO '(A1[5-9]|B90|R76.1|Z20.1)%'
--                                                               LIMIT 1
--                                                        ) IS NULL
--                                                        AND (
--                                                               SELECT mkb
--                                                               FROM UNNEST(
--                                                                             knife_extract_text (
--                                                                                    documentreference.resource,
--                                                                                    '[["medicalReport","diagnosis","code"]]'
--                                                                             )
--                                                                      ) mkb
--                                                               WHERE mkb SIMILAR TO 'F%'
--                                                                      OR mkb SIMILAR TO 'F1%'
--                                                                      OR mkb SIMILAR TO '(B2[0-4])%'
--                                                                      OR mkb SIMILAR TO '(A5[0-469]|A6[03]|Z22.[48]|Z11.3|Z71.2|Z86.1|Z20.2|N89|N34.1|B37.3|B37.4)%'
--                                                                      OR mkb SIMILAR TO '(A1[5-9]|B90|R76.1|Z20.1)%'
--                                                               LIMIT 1
--                                                        ) IS NULL
--                                                 )
--                                                 AND LOWER("patient"."resource"#>>'{name,0,given,0}') = CASE
--                                                        WHEN "documentreference"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                               SPLIT_PART(
--                                                                      SPLIT_PART(
--                                                                             "documentreference"."resource"#>>'{subject,display}',
--                                                                             ',',
--                                                                             1
--                                                                      ),
--                                                                      ' ',
--                                                                      2
--                                                               )
--                                                        )
--                                                        ELSE LOWER("patient"."resource"#>>'{name,0,given,0}')
--                                                 END
--                                                 AND COALESCE(
--                                                        LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                        ''
--                                                 ) = CASE
--                                                        WHEN "documentreference"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                               SPLIT_PART(
--                                                                      SPLIT_PART(
--                                                                             "documentreference"."resource"#>>'{subject,display}',
--                                                                             ',',
--                                                                             1
--                                                                      ),
--                                                                      ' ',
--                                                                      3
--                                                               )
--                                                        )
--                                                        ELSE COALESCE(
--                                                               LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                               ''
--                                                        )
--                                                 END
--                                                 AND CAST("patient"."resource"->>'birthDate' AS "date") = CASE
--                                                        WHEN "documentreference"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN TO_DATE(
--                                                               SPLIT_PART(
--                                                                      "documentreference"."resource"#>>'{subject,display}',
--                                                                      ',',
--                                                                      2
--                                                               ),
--                                                               'DD.mm.YYYY'
--                                                        )
--                                                        ELSE CAST("patient"."resource"->>'birthDate' AS "date")
--                                                 END
--                                          )
--                            ),
--                            "filtered_docs" AS (
--                                   (
--                                          SELECT *
--                                          FROM "patient_docs"
--                                          WHERE JSONB_PATH_EXISTS(
--                                                        "patient_docs"."resource",
--                                                        '$.extension ? (@.url=="urn:extension:diagnosis").url'
--                                                 )
--                                   )
--                                   UNION ALL
--                                   (
--                                          SELECT "patient_docs".*
--                                          FROM "patient_docs"
--                                                 LEFT JOIN "servicerequest" "sr" ON (
--                                                        "sr"."resource" @@ logic_include (
--                                                               "patient_docs"."resource",
--                                                               'context.related',
--                                                               concat (
--                                                                      'or ',
--                                                                      any_identifier_match ("patient_docs"."resource")
--                                                               )
--                                                        )
--                                                        OR "sr"."id" = ANY (
--                                                               ARRAY (
--                                                                      (
--                                                                             SELECT JSONB_PATH_QUERY("patient_docs"."resource", '$.context.related.id')#>>'{}'
--                                                                      )
--                                                               )
--                                                        )
--                                                 )
--                                          WHERE (
--                                                        NOT JSONB_PATH_EXISTS(
--                                                               "patient_docs"."resource",
--                                                               '$.extension ? (@.url=="urn:extension:diagnosis").url'
--                                                        )
--                                                        AND (
--                                                               SELECT mkb
--                                                               FROM UNNEST(
--                                                                             knife_extract_text (
--                                                                                    sr.resource,
--                                                                                    '[["reasonCode","coding",{"system":"urn:CodeSystem:icd-10"},"code"],["reasonReference","identifier",{"system":"urn:CodeSystem:icd-10"},"value"]]'
--                                                                             )
--                                                                      ) mkb
--                                                               WHERE mkb SIMILAR TO 'F%'
--                                                                      OR mkb SIMILAR TO 'F1%'
--                                                                      OR mkb SIMILAR TO '(B2[0-4])%'
--                                                                      OR mkb SIMILAR TO '(A5[0-469]|A6[03]|Z22.[48]|Z11.3|Z71.2|Z86.1|Z20.2|N89|N34.1|B37.3|B37.4)%'
--                                                                      OR mkb SIMILAR TO '(A1[5-9]|B90|R76.1|Z20.1)%'
--                                                               LIMIT 1
--                                                        ) IS NULL
--                                                 )
--                                   )
--                            )
--                            SELECT JSON_AGG(ROW_TO_JSON("documentreference_subselect".*)) AS "documentreference"
--                            FROM (
--                                          SELECT "documentreference"."id" AS "id",
--                                                 "documentreference"."resource_type" AS "resource_type",
--                                                 "documentreference"."status" AS "status",
--                                                 "documentreference"."cts" AS "cts",
--                                                 "documentreference"."ts" AS "ts",
--                                                 "documentreference"."txid" AS "txid",
--                                                 (
--                                                        "documentreference".resource || JSONB_BUILD_OBJECT(
--                                                               'id',
--                                                               "documentreference".id,
--                                                               'resourceType',
--                                                               "documentreference".resource_type
--                                                        )
--                                                 ) AS "resource"
--                                          FROM "filtered_docs" "documentreference"
--                                          ORDER BY CAST(
--                                                        "documentreference"."resource"->>'date' AS "timestamptz"
--                                                 ) DESC NULLS LAST
--                                          LIMIT 1
--                                   ) "documentreference_subselect"
--                     ) AS "documentReference"
--                     (
--                            SELECT JSON_AGG(ROW_TO_JSON("condition_subselect".*)) AS "condition"
--                            FROM (
--                                          SELECT "condition"."id" AS "id",
--                                                 "condition"."resource_type" AS "resource_type",
--                                                 "condition"."status" AS "status",
--                                                 "condition"."cts" AS "cts",
--                                                 "condition"."ts" AS "ts",
--                                                 "condition"."txid" AS "txid",
--                                                 (
--                                                        "condition".resource || JSONB_BUILD_OBJECT(
--                                                               'id',
--                                                               "condition".id,
--                                                               'resourceType',
--                                                               "condition".resource_type
--                                                        )
--                                                 ) AS "resource"
--                                          FROM (
--                                                        SELECT "res".*
--                                                        FROM (
--                                                                      WITH "tag_regexes" AS (
--                                                                             SELECT DISTINCT CASE
--                                                                                           WHEN ("c"."code" LIKE 'A02%') THEN 'A02.*'
--                                                                                           WHEN ("c"."code" LIKE 'A09%') THEN 'A09.*'
--                                                                                           WHEN ("c"."code" LIKE 'A04%') THEN 'A04.*'
--                                                                                           WHEN ("c"."code" LIKE 'A03%') THEN 'A03.*'
--                                                                                           WHEN ("c"."code" LIKE 'A08%') THEN 'A08.*'
--                                                                                           WHEN ("c"."code" LIKE 'A07%') THEN 'A07.*'
--                                                                                           WHEN ("c"."code" LIKE 'A13%') THEN 'A13.*'
--                                                                                           WHEN ("c"."code" LIKE 'A06.1%') THEN 'A06[.]1.*'
--                                                                                           WHEN ("c"."code" LIKE 'A01%') THEN 'A01.*'
--                                                                                           WHEN ("c"."code" LIKE 'A06.3%') THEN 'A06[.]3.*'
--                                                                                           WHEN ("c"."code" LIKE 'A70%') THEN 'A70.*'
--                                                                                           WHEN ("c"."code" LIKE 'A12%') THEN 'A12.*'
--                                                                                           WHEN ("c"."code" LIKE 'A14.1%') THEN 'A14[.]1.*'
--                                                                                           WHEN ("c"."code" LIKE 'P02%') THEN 'P02.*'
--                                                                                           WHEN ("c"."code" LIKE 'P01%') THEN 'P01.*'
--                                                                                           WHEN ("c"."code" LIKE 'A05%') THEN 'A05.*'
--                                                                                           WHEN ("c"."code" LIKE 'R01%') THEN 'R01.*'
--                                                                                           ELSE 'nothing_tag'
--                                                                                    END AS "tag_regex"
--                                                                             FROM "flag" "f",
--                                                                                    LATERAL (
--                                                                                           (
--                                                                                                  SELECT "f"."resource"#>>'{code,coding,0,code}' AS "code"
--                                                                                           )
--                                                                                    ) "c"
--                                                                             WHERE (
--                                                                                           "f"."resource" @@ logic_revinclude("patient"."resource", "patient"."id", 'subject')
--                                                                                           AND (
--                                                                                                  "f"."resource"#>>'{period,end}' IS NULL
--                                                                                                  OR CAST("f"."resource"#>>'{period,end}' AS "date") > CURRENT_DATE
--                                                                                           )
--                                                                                    )
--                                                                      ),
--                                                                      "_rules" AS (
--                                                                             SELECT JSONB_PATH_QUERY(
--                                                                                           "concept"."resource",
--                                                                                           CAST(
--                                                                                                  concat (
--                                                                                                         '$.property.condition ? (@.tag.code like_regex "',
--                                                                                                         "t"."tag_regex",
--                                                                                                         '")'
--                                                                                                  ) AS "jsonpath"
--                                                                                           )
--                                                                                    ) AS "_rule"
--                                                                             FROM "concept" "concept",
--                                                                                    "tag_regexes" "t"
--                                                                             WHERE (
--                                                                                           "concept"."resource"#>>'{system}' = 'urn:CodeSystem:r21.resource-tag'
--                                                                                           AND "concept"."resource"#>>'{code}' = 'Condition'
--                                                                                    )
--                                                                      ),
--                                                                      "rules" AS (
--                                                                             SELECT "r"."_rule"#>>'{mkb-from,code}' AS "mkb_from",
--                                                                                    "r"."_rule"#>>'{mkb-to,code}' AS "mkb_to"
--                                                                             FROM "_rules" "r"
--                                                                      ),
--                                                                      "raig" AS (
--                                                                             SELECT "concept"."resource"#>'{property,condition}' AS "codes"
--                                                                             FROM "concept" "concept"
--                                                                             WHERE (
--                                                                                           "concept"."resource"#>>'{system}' = 'urn:CodeSystem:condition-tag'
--                                                                                           AND "concept"."resource"#>>'{code}' = 'raig'
--                                                                                           AND (
--                                                                                                  SELECT 1
--                                                                                                  FROM "episodeofcare"
--                                                                                                  WHERE (
--                                                                                                                "episodeofcare"."resource" @@ logic_revinclude("patient"."resource", "patient"."id", 'patient')
--                                                                                                                AND in_period_matched_identifier(
--                                                                                                                       "episodeofcare"."cts",
--                                                                                                                       "episodeofcare"."resource",
--                                                                                                                       "patient"."resource",
--                                                                                                                       'patient'
--                                                                                                                )
--                                                                                                                AND "episodeofcare"."resource" @@ 'type.#.coding.#(system = "urn:CodeSystem:episodeofcare-type" and (code = "PregnantCard"))'::jsquery
--                                                                                                                AND "episodeofcare"."resource"#>>'{status}' <> 'finished'
--                                                                                                                AND CAST("patient"."resource"->>'birthDate' AS "date") = CASE
--                                                                                                                       WHEN SPLIT_PART(
--                                                                                                                              "episodeofcare"."resource"#>>'{patient,display}',
--                                                                                                                              ',',
--                                                                                                                              2
--                                                                                                                       ) <> '' THEN TO_DATE(
--                                                                                                                              SPLIT_PART(
--                                                                                                                                     "episodeofcare"."resource"#>>'{patient,display}',
--                                                                                                                                     ',',
--                                                                                                                                     2
--                                                                                                                              ),
--                                                                                                                              'DD.mm.YYYY'
--                                                                                                                       )
--                                                                                                                       ELSE CAST("patient"."resource"->>'birthDate' AS "date")
--                                                                                                                END
--                                                                                                         )
--                                                                                                  LIMIT 1
--                                                                                           ) IS NOT NULL
--                                                                                    )
--                                                                             LIMIT 1
--                                                                      ), "grouped" AS (
--                                                                             SELECT JSONB_AGG(ROW_TO_JSON("cond".*)) AS "agg"
--                                                                             FROM "condition" "cond"
--                                                                             WHERE (
--                                                                                           (
--                                                                                                  "cond"."resource" @@ logic_revinclude(
--                                                                                                         "patient"."resource",
--                                                                                                         "patient"."id",
--                                                                                                         'subject',
--                                                                                                         ' and not clinicalStatus.coding.#.code="inactive" and not verificationStatus.coding.#.code="entered-in-error"'
--                                                                                                  )
--                                                                                                  AND in_period_matched_identifier(
--                                                                                                         "cond"."cts",
--                                                                                                         "cond"."resource",
--                                                                                                         "patient"."resource",
--                                                                                                         'subject'
--                                                                                                  )
--                                                                                           )
--                                                                                           AND LOWER("patient"."resource"#>>'{name,0,given,0}') = CASE
--                                                                                                  WHEN "cond"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                                                                         SPLIT_PART(
--                                                                                                                SPLIT_PART("cond"."resource"#>>'{subject,display}', ',', 1),
--                                                                                                                ' ',
--                                                                                                                2
--                                                                                                         )
--                                                                                                  )
--                                                                                                  ELSE LOWER("patient"."resource"#>>'{name,0,given,0}')
--                                                                                           END
--                                                                                           AND COALESCE(
--                                                                                                  LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                                                                  ''
--                                                                                           ) = CASE
--                                                                                                  WHEN "cond"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                                                                         SPLIT_PART(
--                                                                                                                SPLIT_PART("cond"."resource"#>>'{subject,display}', ',', 1),
--                                                                                                                ' ',
--                                                                                                                3
--                                                                                                         )
--                                                                                                  )
--                                                                                                  ELSE COALESCE(
--                                                                                                         LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                                                                         ''
--                                                                                                  )
--                                                                                           END
--                                                                                           AND CAST("patient"."resource"->>'birthDate' AS "date") = CASE
--                                                                                                  WHEN "cond"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN TO_DATE(
--                                                                                                         SPLIT_PART("cond"."resource"#>>'{subject,display}', ',', 2),
--                                                                                                         'DD.mm.YYYY'
--                                                                                                  )
--                                                                                                  ELSE CAST("patient"."resource"->>'birthDate' AS "date")
--                                                                                           END
--                                                                                    )
--                                                                             GROUP BY knife_extract_text(
--                                                                                           cond.resource::JSONB,
--                                                                                           '[["code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'::JSONB
--                                                                                    )
--                                                                      ),
--                                                                      "limited" AS (
--                                                                             SELECT (
--                                                                                           SELECT "grouped_agg"
--                                                                                           FROM JSONB_ARRAY_ELEMENTS("grouped"."agg") "grouped_agg"
--                                                                                           ORDER BY "grouped_agg"#>>'{resource,recordedDate}' DESC NULLS LAST
--                                                                                           LIMIT 1
--                                                                                    ) AS "condition_row"
--                                                                             FROM "grouped"
--                                                                      ),
--                                                                      "to_record" AS (
--                                                                             SELECT "x".*
--                                                                             FROM "limited" "cond",
--                                                                                    JSONB_TO_RECORD("condition_row") "x" (
--                                                                                           id TEXT,
--                                                                                           txid INT8,
--                                                                                           ts TIMESTAMPTZ,
--                                                                                           cts TIMESTAMPTZ,
--                                                                                           status TEXT,
--                                                                                           resource_type TEXT,
--                                                                                           resource JSONB
--                                                                                    )
--                                                                      )
--                                                                      SELECT *
--                                                                      FROM "to_record" "cond"
--                                                                      WHERE (
--                                                                                    TRUE
--                                                                                    AND (
--                                                                                           SELECT mkb
--                                                                                           FROM UNNEST(
--                                                                                                         knife_extract_text (
--                                                                                                                cond.resource,
--                                                                                                                '[["code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
--                                                                                                         )
--                                                                                                  ) mkb
--                                                                                           WHERE mkb SIMILAR TO 'F%'
--                                                                                                  OR mkb SIMILAR TO 'F1%'
--                                                                                                  OR mkb SIMILAR TO '(B2[0-4])%'
--                                                                                                  OR mkb SIMILAR TO '(A5[0-469]|A6[03]|Z22.[48]|Z11.3|Z71.2|Z86.1|Z20.2|N89|N34.1|B37.3|B37.4)%'
--                                                                                                  OR mkb SIMILAR TO '(A1[5-9]|B90|R76.1|Z20.1)%'
--                                                                                           LIMIT 1
--                                                                                    ) IS NULL
--                                                                                    AND (
--                                                                                           (
--                                                                                                  SELECT 1
--                                                                                                  FROM "rules" "r"
--                                                                                                  WHERE (
--                                                                                                                (
--                                                                                                                       (
--                                                                                                                              knife_extract_text(
--                                                                                                                                     cond.resource,
--                                                                                                                                     '[["code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
--                                                                                                                              )
--                                                                                                                       ) [1] >= "r"."mkb_from"
--                                                                                                                       AND (
--                                                                                                                              knife_extract_text(
--                                                                                                                                     cond.resource,
--                                                                                                                                     '[["code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
--                                                                                                                              )
--                                                                                                                       ) [1] <= "r"."mkb_to"
--                                                                                                                )
--                                                                                                                OR (
--                                                                                                                       (
--                                                                                                                              knife_extract_text(
--                                                                                                                                     cond.resource,
--                                                                                                                                     '[["code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
--                                                                                                                              )
--                                                                                                                       ) [1] LIKE concat("r"."mkb_to", '%')
--                                                                                                                )
--                                                                                                         )
--                                                                                                  LIMIT 1
--                                                                                           )
--                                                                                           UNION
--                                                                                           (
--                                                                                                  SELECT 1
--                                                                                                  FROM "raig" "raig"
--                                                                                                  WHERE JSONB_PATH_EXISTS(
--                                                                                                                "raig"."codes",
--                                                                                                                CAST(
--                                                                                                                       concat(
--                                                                                                                              '$ ? (@ == "',
--(
--                                                                                                                                     knife_extract_text(
--                                                                                                                                            cond.resource,
--                                                                                                                                            '[["code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
--                                                                                                                                     )
--                                                                                                                              ) [1],
--                                                                                                                              '")'
--                                                                                                                       ) AS "jsonpath"
--                                                                                                                )
--                                                                                                         )
--                                                                                                  LIMIT 1
--                                                                                           )
--                                                                                    ) IS NOT NULL
--                                                                             )
--                                                               ) "res"
--                                                 ) "condition"
--                                          ORDER BY "condition"."resource"->>'recordedDate' DESC NULLS LAST
--                                          LIMIT NULL
--                                   ) "condition_subselect"
--                     ) AS "conditionRegistry"
--                     (
--                            SELECT JSON_AGG(ROW_TO_JSON("servicerequest_subselect".*)) AS "servicerequest"
--                            FROM (
--                                          SELECT "servicerequest"."id" AS "id",
--                                                 "servicerequest"."resource_type" AS "resource_type",
--                                                 "servicerequest"."status" AS "status",
--                                                 "servicerequest"."cts" AS "cts",
--                                                 "servicerequest"."ts" AS "ts",
--                                                 "servicerequest"."txid" AS "txid",
--                                                 (
--                                                        "servicerequest".resource || JSONB_BUILD_OBJECT(
--                                                               'id',
--                                                               "servicerequest".id,
--                                                               'resourceType',
--                                                               "servicerequest".resource_type
--                                                        )
--                                                 ) AS "resource",
--                                                 (
--                                                        SELECT ROW_TO_JSON("diagnosticreport_subselect".*) AS "diagnosticreport"
--                                                        FROM (
--                                                                      SELECT "diagnosticreport"."id" AS "id",
--                                                                             "diagnosticreport"."resource_type" AS "resource_type",
--                                                                             "diagnosticreport"."status" AS "status",
--                                                                             "diagnosticreport"."cts" AS "cts",
--                                                                             "diagnosticreport"."ts" AS "ts",
--                                                                             "diagnosticreport"."txid" AS "txid",
--                                                                             (
--                                                                                    "diagnosticreport".resource || JSONB_BUILD_OBJECT(
--                                                                                           'id',
--                                                                                           "diagnosticreport".id,
--                                                                                           'resourceType',
--                                                                                           "diagnosticreport".resource_type
--                                                                                    )
--                                                                             ) AS "resource"
--                                                                      FROM "diagnosticreport"
--                                                                      WHERE "diagnosticreport"."resource" @@ logic_revinclude(
--                                                                                    "servicerequest"."resource",
--                                                                                    "servicerequest"."id",
--                                                                                    'basedOn.#'
--                                                                             )
--                                                                      ORDER BY "ts" DESC
--                                                                      LIMIT 1
--                                                               ) "diagnosticreport_subselect"
--                                                 ) AS "diagnosticReport"
--                                          FROM "servicerequest"
--                                          WHERE (
--                                                        (
--                                                               "servicerequest"."resource" @@ logic_revinclude("patient"."resource", "patient"."id", 'subject')
--                                                               AND in_period_matched_identifier(
--                                                                      "servicerequest"."cts",
--                                                                      "servicerequest"."resource",
--                                                                      "patient"."resource",
--                                                                      'subject'
--                                                               )
--                                                               AND "servicerequest"."resource" @@ 'category.#.coding.#(system= "urn:CodeSystem:servicerequest-category" and code = "Referral-LMI")'::jsquery
--                                                               AND (
--                                                                      SELECT mkb
--                                                                      FROM UNNEST(
--                                                                                    knife_extract_text (
--                                                                                           servicerequest.resource,
--                                                                                           '[["reasonCode","coding",{"system":"urn:CodeSystem:icd-10"},"code"],["reasonReference","identifier",{"system":"urn:CodeSystem:icd-10"},"value"]]'
--                                                                                    )
--                                                                             ) mkb
--                                                                      WHERE mkb SIMILAR TO 'F%'
--                                                                             OR mkb SIMILAR TO 'F1%'
--                                                                             OR mkb SIMILAR TO '(B2[0-4])%'
--                                                                             OR mkb SIMILAR TO '(A5[0-469]|A6[03]|Z22.[48]|Z11.3|Z71.2|Z86.1|Z20.2|N89|N34.1|B37.3|B37.4)%'
--                                                                             OR mkb SIMILAR TO '(A1[5-9]|B90|R76.1|Z20.1)%'
--                                                                      LIMIT 1
--                                                               ) IS NULL
--                                                        )
--                                                        AND LOWER("patient"."resource"#>>'{name,0,given,0}') = CASE
--                                                               WHEN "servicerequest"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                                      SPLIT_PART(
--                                                                             SPLIT_PART(
--                                                                                    "servicerequest"."resource"#>>'{subject,display}',
--                                                                                    ',',
--                                                                                    1
--                                                                             ),
--                                                                             ' ',
--                                                                             2
--                                                                      )
--                                                               )
--                                                               ELSE LOWER("patient"."resource"#>>'{name,0,given,0}')
--                                                        END
--                                                        AND COALESCE(
--                                                               LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                               ''
--                                                        ) = CASE
--                                                               WHEN "servicerequest"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                                      SPLIT_PART(
--                                                                             SPLIT_PART(
--                                                                                    "servicerequest"."resource"#>>'{subject,display}',
--                                                                                    ',',
--                                                                                    1
--                                                                             ),
--                                                                             ' ',
--                                                                             3
--                                                                      )
--                                                               )
--                                                               ELSE COALESCE(
--                                                                      LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                                      ''
--                                                               )
--                                                        END
--                                                        AND CAST("patient"."resource"->>'birthDate' AS "date") = CASE
--                                                               WHEN "servicerequest"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN TO_DATE(
--                                                                      SPLIT_PART(
--                                                                             "servicerequest"."resource"#>>'{subject,display}',
--                                                                             ',',
--                                                                             2
--                                                                      ),
--                                                                      'DD.mm.YYYY'
--                                                               )
--                                                               ELSE CAST("patient"."resource"->>'birthDate' AS "date")
--                                                        END
--                                                 )
--                                          ORDER BY CAST(
--                                                        "servicerequest"."resource"->>'authoredOn' AS "timestamptz"
--                                                 ) DESC NULLS FIRST
--                                          LIMIT 1
--                                   ) "servicerequest_subselect"
--                     ) AS "laboratory"
--                     (
--                            SELECT JSON_AGG(ROW_TO_JSON("task_subselect".*)) AS "task"
--                            FROM (
--                                          SELECT "survey"."id" AS "id",
--                                                 "survey"."resource_type" AS "resource_type",
--                                                 "survey"."status" AS "status",
--                                                 "survey"."cts" AS "cts",
--                                                 "survey"."ts" AS "ts",
--                                                 "survey"."txid" AS "txid",
--                                                 (
--                                                        "survey".resource || JSONB_BUILD_OBJECT(
--                                                               'id',
--                                                               "survey".id,
--                                                               'resourceType',
--                                                               "survey".resource_type
--                                                        )
--                                                 ) AS "resource"
--                                          FROM "task" "survey"
--                                          WHERE (
--                                                        "survey"."resource" @@ logic_revinclude(
--                                                               "patient"."resource",
--                                                               "patient"."id",
--                                                               'for',
--                                                               ' and code.coding.#(system="urn:CodeSystem:chu-task-code" and code="remoteQuestioning")'
--                                                        )
--                                                        AND in_period_matched_identifier(
--                                                               "survey"."cts",
--                                                               "survey"."resource",
--                                                               "patient"."resource",
--                                                               'for'
--                                                        )
--                                                 )
--                                          LIMIT 1
--                                   ) "task_subselect"
--                     ) AS "survey"
--                     (
--                            SELECT JSON_AGG(ROW_TO_JSON("condition_subselect".*)) AS "condition"
--                            FROM (
--                                          SELECT "condition"."id" AS "id",
--                                                 "condition"."resource_type" AS "resource_type",
--                                                 "condition"."status" AS "status",
--                                                 "condition"."cts" AS "cts",
--                                                 "condition"."ts" AS "ts",
--                                                 "condition"."txid" AS "txid",
--                                                 (
--                                                        "condition".resource || JSONB_BUILD_OBJECT(
--                                                               'id',
--                                                               "condition".id,
--                                                               'resourceType',
--                                                               "condition".resource_type
--                                                        )
--                                                 ) AS "resource"
--                                          FROM (
--                                                        SELECT "res".*
--                                                        FROM (
--                                                                      WITH "tag_regexes" AS (
--                                                                             SELECT DISTINCT CASE
--                                                                                           WHEN ("c"."code" LIKE 'A02%') THEN 'A02.*'
--                                                                                           WHEN ("c"."code" LIKE 'A09%') THEN 'A09.*'
--                                                                                           WHEN ("c"."code" LIKE 'A04%') THEN 'A04.*'
--                                                                                           WHEN ("c"."code" LIKE 'A03%') THEN 'A03.*'
--                                                                                           WHEN ("c"."code" LIKE 'A08%') THEN 'A08.*'
--                                                                                           WHEN ("c"."code" LIKE 'A07%') THEN 'A07.*'
--                                                                                           WHEN ("c"."code" LIKE 'A13%') THEN 'A13.*'
--                                                                                           WHEN ("c"."code" LIKE 'A06.1%') THEN 'A06[.]1.*'
--                                                                                           WHEN ("c"."code" LIKE 'A01%') THEN 'A01.*'
--                                                                                           WHEN ("c"."code" LIKE 'A06.3%') THEN 'A06[.]3.*'
--                                                                                           WHEN ("c"."code" LIKE 'A70%') THEN 'A70.*'
--                                                                                           WHEN ("c"."code" LIKE 'A12%') THEN 'A12.*'
--                                                                                           WHEN ("c"."code" LIKE 'A14.1%') THEN 'A14[.]1.*'
--                                                                                           WHEN ("c"."code" LIKE 'P02%') THEN 'P02.*'
--                                                                                           WHEN ("c"."code" LIKE 'P01%') THEN 'P01.*'
--                                                                                           WHEN ("c"."code" LIKE 'A05%') THEN 'A05.*'
--                                                                                           WHEN ("c"."code" LIKE 'R01%') THEN 'R01.*'
--                                                                                           ELSE 'nothing_tag'
--                                                                                    END AS "tag_regex"
--                                                                             FROM "flag" "f",
--                                                                                    LATERAL (
--                                                                                           (
--                                                                                                  SELECT "f"."resource"#>>'{code,coding,0,code}' AS "code"
--                                                                                           )
--                                                                                    ) "c"
--                                                                             WHERE (
--                                                                                           "f"."resource" @@ logic_revinclude("patient"."resource", "patient"."id", 'subject')
--                                                                                           AND (
--                                                                                                  "f"."resource"#>>'{period,end}' IS NULL
--                                                                                                  OR CAST("f"."resource"#>>'{period,end}' AS "date") > CURRENT_DATE
--                                                                                           )
--                                                                                    )
--                                                                      ),
--                                                                      "_rules" AS (
--                                                                             SELECT JSONB_PATH_QUERY(
--                                                                                           "concept"."resource",
--                                                                                           CAST(
--                                                                                                  concat (
--                                                                                                         '$.property.condition ? (@.tag.code like_regex "',
--                                                                                                         "t"."tag_regex",
--                                                                                                         '")'
--                                                                                                  ) AS "jsonpath"
--                                                                                           )
--                                                                                    ) AS "_rule"
--                                                                             FROM "concept" "concept",
--                                                                                    "tag_regexes" "t"
--                                                                             WHERE (
--                                                                                           "concept"."resource"#>>'{system}' = 'urn:CodeSystem:r21.resource-tag'
--                                                                                           AND "concept"."resource"#>>'{code}' = 'Condition'
--                                                                                    )
--                                                                      ),
--                                                                      "rules" AS (
--                                                                             SELECT "r"."_rule"#>>'{mkb-from,code}' AS "mkb_from",
--                                                                                    "r"."_rule"#>>'{mkb-to,code}' AS "mkb_to"
--                                                                             FROM "_rules" "r"
--                                                                      ),
--                                                                      "raig" AS (
--                                                                             SELECT "concept"."resource"#>'{property,condition}' AS "codes"
--                                                                             FROM "concept" "concept"
--                                                                             WHERE (
--                                                                                           "concept"."resource"#>>'{system}' = 'urn:CodeSystem:condition-tag'
--                                                                                           AND "concept"."resource"#>>'{code}' = 'raig'
--                                                                                           AND (
--                                                                                                  SELECT 1
--                                                                                                  FROM "episodeofcare"
--                                                                                                  WHERE (
--                                                                                                                "episodeofcare"."resource" @@ logic_revinclude("patient"."resource", "patient"."id", 'patient')
--                                                                                                                AND in_period_matched_identifier(
--                                                                                                                       "episodeofcare"."cts",
--                                                                                                                       "episodeofcare"."resource",
--                                                                                                                       "patient"."resource",
--                                                                                                                       'patient'
--                                                                                                                )
--                                                                                                                AND "episodeofcare"."resource" @@ 'type.#.coding.#(system = "urn:CodeSystem:episodeofcare-type" and (code = "PregnantCard"))'::jsquery
--                                                                                                                AND "episodeofcare"."resource"#>>'{status}' <> 'finished'
--                                                                                                                AND CAST("patient"."resource"->>'birthDate' AS "date") = CASE
--                                                                                                                       WHEN SPLIT_PART(
--                                                                                                                              "episodeofcare"."resource"#>>'{patient,display}',
--                                                                                                                              ',',
--                                                                                                                              2
--                                                                                                                       ) <> '' THEN TO_DATE(
--                                                                                                                              SPLIT_PART(
--                                                                                                                                     "episodeofcare"."resource"#>>'{patient,display}',
--                                                                                                                                     ',',
--                                                                                                                                     2
--                                                                                                                              ),
--                                                                                                                              'DD.mm.YYYY'
--                                                                                                                       )
--                                                                                                                       ELSE CAST("patient"."resource"->>'birthDate' AS "date")
--                                                                                                                END
--                                                                                                         )
--                                                                                                  LIMIT 1
--                                                                                           ) IS NOT NULL
--                                                                                    )
--                                                                             LIMIT 1
--                                                                      ), "grouped" AS (
--                                                                             SELECT JSONB_AGG(ROW_TO_JSON("cond".*)) AS "agg"
--                                                                             FROM "condition" "cond"
--                                                                             WHERE (
--                                                                                           (
--                                                                                                  "cond"."resource" @@ logic_revinclude(
--                                                                                                         "patient"."resource",
--                                                                                                         "patient"."id",
--                                                                                                         'subject',
--                                                                                                         ' and not clinicalStatus.coding.#.code="inactive" and not verificationStatus.coding.#.code="entered-in-error"'
--                                                                                                  )
--                                                                                                  AND in_period_matched_identifier(
--                                                                                                         "cond"."cts",
--                                                                                                         "cond"."resource",
--                                                                                                         "patient"."resource",
--                                                                                                         'subject'
--                                                                                                  )
--                                                                                           )
--                                                                                           AND LOWER("patient"."resource"#>>'{name,0,given,0}') = CASE
--                                                                                                  WHEN "cond"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                                                                         SPLIT_PART(
--                                                                                                                SPLIT_PART("cond"."resource"#>>'{subject,display}', ',', 1),
--                                                                                                                ' ',
--                                                                                                                2
--                                                                                                         )
--                                                                                                  )
--                                                                                                  ELSE LOWER("patient"."resource"#>>'{name,0,given,0}')
--                                                                                           END
--                                                                                           AND COALESCE(
--                                                                                                  LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                                                                  ''
--                                                                                           ) = CASE
--                                                                                                  WHEN "cond"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                                                                         SPLIT_PART(
--                                                                                                                SPLIT_PART("cond"."resource"#>>'{subject,display}', ',', 1),
--                                                                                                                ' ',
--                                                                                                                3
--                                                                                                         )
--                                                                                                  )
--                                                                                                  ELSE COALESCE(
--                                                                                                         LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                                                                         ''
--                                                                                                  )
--                                                                                           END
--                                                                                           AND CAST("patient"."resource"->>'birthDate' AS "date") = CASE
--                                                                                                  WHEN "cond"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN TO_DATE(
--                                                                                                         SPLIT_PART("cond"."resource"#>>'{subject,display}', ',', 2),
--                                                                                                         'DD.mm.YYYY'
--                                                                                                  )
--                                                                                                  ELSE CAST("patient"."resource"->>'birthDate' AS "date")
--                                                                                           END
--                                                                                    )
--                                                                             GROUP BY knife_extract_text(
--                                                                                           cond.resource::JSONB,
--                                                                                           '[["code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'::JSONB
--                                                                                    )
--                                                                      ),
--                                                                      "limited" AS (
--                                                                             SELECT (
--                                                                                           SELECT "grouped_agg"
--                                                                                           FROM JSONB_ARRAY_ELEMENTS("grouped"."agg") "grouped_agg"
--                                                                                           ORDER BY "grouped_agg"#>>'{resource,recordedDate}' DESC NULLS LAST
--                                                                                           LIMIT 1
--                                                                                    ) AS "condition_row"
--                                                                             FROM "grouped"
--                                                                      ),
--                                                                      "to_record" AS (
--                                                                             SELECT "x".*
--                                                                             FROM "limited" "cond",
--                                                                                    JSONB_TO_RECORD("condition_row") "x" (
--                                                                                           id TEXT,
--                                                                                           txid INT8,
--                                                                                           ts TIMESTAMPTZ,
--                                                                                           cts TIMESTAMPTZ,
--                                                                                           status TEXT,
--                                                                                           resource_type TEXT,
--                                                                                           resource JSONB
--                                                                                    )
--                                                                      )
--                                                                      SELECT *
--                                                                      FROM "to_record" "cond"
--                                                                      WHERE (
--                                                                                    TRUE
--                                                                                    AND (
--                                                                                           SELECT mkb
--                                                                                           FROM UNNEST(
--                                                                                                         knife_extract_text (
--                                                                                                                cond.resource,
--                                                                                                                '[["code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
--                                                                                                         )
--                                                                                                  ) mkb
--                                                                                           WHERE mkb SIMILAR TO 'F%'
--                                                                                                  OR mkb SIMILAR TO 'F1%'
--                                                                                                  OR mkb SIMILAR TO '(B2[0-4])%'
--                                                                                                  OR mkb SIMILAR TO '(A5[0-469]|A6[03]|Z22.[48]|Z11.3|Z71.2|Z86.1|Z20.2|N89|N34.1|B37.3|B37.4)%'
--                                                                                                  OR mkb SIMILAR TO '(A1[5-9]|B90|R76.1|Z20.1)%'
--                                                                                           LIMIT 1
--                                                                                    ) IS NULL
--                                                                                    AND (
--                                                                                           (
--                                                                                                  SELECT 1
--                                                                                                  FROM "rules" "r"
--                                                                                                  WHERE (
--                                                                                                                (
--                                                                                                                       (
--                                                                                                                              knife_extract_text(
--                                                                                                                                     cond.resource,
--                                                                                                                                     '[["code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
--                                                                                                                              )
--                                                                                                                       ) [1] >= "r"."mkb_from"
--                                                                                                                       AND (
--                                                                                                                              knife_extract_text(
--                                                                                                                                     cond.resource,
--                                                                                                                                     '[["code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
--                                                                                                                              )
--                                                                                                                       ) [1] <= "r"."mkb_to"
--                                                                                                                )
--                                                                                                                OR (
--                                                                                                                       (
--                                                                                                                              knife_extract_text(
--                                                                                                                                     cond.resource,
--                                                                                                                                     '[["code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
--                                                                                                                              )
--                                                                                                                       ) [1] LIKE concat("r"."mkb_to", '%')
--                                                                                                                )
--                                                                                                         )
--                                                                                                  LIMIT 1
--                                                                                           )
--                                                                                           UNION
--                                                                                           (
--                                                                                                  SELECT 1
--                                                                                                  FROM "raig" "raig"
--                                                                                                  WHERE JSONB_PATH_EXISTS(
--                                                                                                                "raig"."codes",
--                                                                                                                CAST(
--                                                                                                                       concat(
--                                                                                                                              '$ ? (@ == "',
--(
--                                                                                                                                     knife_extract_text(
--                                                                                                                                            cond.resource,
--                                                                                                                                            '[["code","coding",{"system":"urn:CodeSystem:icd-10"},"code"]]'
--                                                                                                                                     )
--                                                                                                                              ) [1],
--                                                                                                                              '")'
--                                                                                                                       ) AS "jsonpath"
--                                                                                                                )
--                                                                                                         )
--                                                                                                  LIMIT 1
--                                                                                           )
--                                                                                    ) IS NULL
--                                                                             )
--                                                               ) "res"
--                                                 ) "condition"
--                                          ORDER BY "condition"."resource"->>'recordedDate' DESC NULLS LAST
--                                          LIMIT 1
--                                   ) "condition_subselect"
--                     ) AS "conditionOther"
--                     (
--                            SELECT JSON_AGG(ROW_TO_JSON("servicerequest_subselect".*)) AS "servicerequest"
--                            FROM (
--                                          SELECT "servicerequest"."id" AS "id",
--                                                 "servicerequest"."resource_type" AS "resource_type",
--                                                 "servicerequest"."status" AS "status",
--                                                 "servicerequest"."cts" AS "cts",
--                                                 "servicerequest"."ts" AS "ts",
--                                                 "servicerequest"."txid" AS "txid",
--                                                 (
--                                                        "servicerequest".resource || JSONB_BUILD_OBJECT(
--                                                               'id',
--                                                               "servicerequest".id,
--                                                               'resourceType',
--                                                               "servicerequest".resource_type
--                                                        )
--                                                 ) AS "resource",
--                                                 (
--                                                        SELECT ROW_TO_JSON("diagnosticreport_subselect".*) AS "diagnosticreport"
--                                                        FROM (
--                                                                      SELECT "diagnosticreport"."id" AS "id",
--                                                                             "diagnosticreport"."resource_type" AS "resource_type",
--                                                                             "diagnosticreport"."status" AS "status",
--                                                                             "diagnosticreport"."cts" AS "cts",
--                                                                             "diagnosticreport"."ts" AS "ts",
--                                                                             "diagnosticreport"."txid" AS "txid",
--                                                                             (
--                                                                                    "diagnosticreport".resource || JSONB_BUILD_OBJECT(
--                                                                                           'id',
--                                                                                           "diagnosticreport".id,
--                                                                                           'resourceType',
--                                                                                           "diagnosticreport".resource_type
--                                                                                    )
--                                                                             ) AS "resource"
--                                                                      FROM "diagnosticreport"
--                                                                      WHERE "diagnosticreport"."resource" @@ logic_revinclude(
--                                                                                    "servicerequest"."resource",
--                                                                                    "servicerequest"."id",
--                                                                                    'basedOn.#',
--                                                                                    ' and (category.#.coding.#(code="basic-result" and system="urn:CodeSystem:diagnosticreport-categoryIMI") or not category.#.coding.#(system="urn:CodeSystem:diagnosticreport-categoryIMI"))'
--                                                                             )
--                                                                      LIMIT 1
--                                                               ) "diagnosticreport_subselect"
--                                                 ) AS "diagnosticReport"
--                                          FROM "servicerequest"
--                                          WHERE (
--                                                        (
--                                                               "servicerequest"."resource" @@ logic_revinclude("patient"."resource", "patient"."id", 'subject')
--                                                               AND in_period_matched_identifier(
--                                                                      "servicerequest"."cts",
--                                                                      "servicerequest"."resource",
--                                                                      "patient"."resource",
--                                                                      'subject'
--                                                               )
--                                                               AND "servicerequest"."resource" @@ 'category.#.coding.#(system= "urn:CodeSystem:servicerequest-category" and code = "Referral-IMI")'::jsquery
--                                                               AND (
--                                                                      SELECT mkb
--                                                                      FROM UNNEST(
--                                                                                    knife_extract_text (
--                                                                                           servicerequest.resource,
--                                                                                           '[["reasonCode","coding",{"system":"urn:CodeSystem:icd-10"},"code"],["reasonReference","identifier",{"system":"urn:CodeSystem:icd-10"},"value"]]'
--                                                                                    )
--                                                                             ) mkb
--                                                                      WHERE mkb SIMILAR TO 'F%'
--                                                                             OR mkb SIMILAR TO 'F1%'
--                                                                             OR mkb SIMILAR TO '(B2[0-4])%'
--                                                                             OR mkb SIMILAR TO '(A5[0-469]|A6[03]|Z22.[48]|Z11.3|Z71.2|Z86.1|Z20.2|N89|N34.1|B37.3|B37.4)%'
--                                                                             OR mkb SIMILAR TO '(A1[5-9]|B90|R76.1|Z20.1)%'
--                                                                      LIMIT 1
--                                                               ) IS NULL
--                                                               AND "servicerequest"."resource" @@ 'code.coding.#(system = "urn:CodeSystem:diagnostic-tests" and code = *)'::jsquery
--                                                        )
--                                                        AND LOWER("patient"."resource"#>>'{name,0,given,0}') = CASE
--                                                               WHEN "servicerequest"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                                      SPLIT_PART(
--                                                                             SPLIT_PART(
--                                                                                    "servicerequest"."resource"#>>'{subject,display}',
--                                                                                    ',',
--                                                                                    1
--                                                                             ),
--                                                                             ' ',
--                                                                             2
--                                                                      )
--                                                               )
--                                                               ELSE LOWER("patient"."resource"#>>'{name,0,given,0}')
--                                                        END
--                                                        AND COALESCE(
--                                                               LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                               ''
--                                                        ) = CASE
--                                                               WHEN "servicerequest"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                                      SPLIT_PART(
--                                                                             SPLIT_PART(
--                                                                                    "servicerequest"."resource"#>>'{subject,display}',
--                                                                                    ',',
--                                                                                    1
--                                                                             ),
--                                                                             ' ',
--                                                                             3
--                                                                      )
--                                                               )
--                                                               ELSE COALESCE(
--                                                                      LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                                      ''
--                                                               )
--                                                        END
--                                                        AND CAST("patient"."resource"->>'birthDate' AS "date") = CASE
--                                                               WHEN "servicerequest"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN TO_DATE(
--                                                                      SPLIT_PART(
--                                                                             "servicerequest"."resource"#>>'{subject,display}',
--                                                                             ',',
--                                                                             2
--                                                                      ),
--                                                                      'DD.mm.YYYY'
--                                                               )
--                                                               ELSE CAST("patient"."resource"->>'birthDate' AS "date")
--                                                        END
--                                                 )
--                                          ORDER BY CAST(
--                                                        "servicerequest"."resource"->>'authoredOn' AS "timestamptz"
--                                                 ) DESC NULLS FIRST
--                                          LIMIT 1
--                                   ) "servicerequest_subselect"
--                     ) AS "instrumental"
--                     (
--                            SELECT JSON_AGG(ROW_TO_JSON("diagnosticreport_subselect".*)) AS "diagnosticreport"
--                            FROM (
--                                          SELECT "diagnosticreport"."id" AS "id",
--                                                 "diagnosticreport"."resource_type" AS "resource_type",
--                                                 "diagnosticreport"."status" AS "status",
--                                                 "diagnosticreport"."cts" AS "cts",
--                                                 "diagnosticreport"."ts" AS "ts",
--                                                 "diagnosticreport"."txid" AS "txid",
--                                                 (
--                                                        "diagnosticreport".resource || JSONB_BUILD_OBJECT(
--                                                               'id',
--                                                               "diagnosticreport".id,
--                                                               'resourceType',
--                                                               "diagnosticreport".resource_type
--                                                        )
--                                                 ) AS "resource"
--                                          FROM "diagnosticreport"
--                                                 LEFT JOIN "servicerequest" "sr" ON "sr"."resource" @@ any_identifier_match ("diagnosticreport"."resource")
--                                          WHERE (
--                                                        (
--                                                               "diagnosticreport"."resource" @@ logic_revinclude("patient"."resource", "patient"."id", 'subject')
--                                                               AND in_period_matched_identifier(
--                                                                      "diagnosticreport"."cts",
--                                                                      "diagnosticreport"."resource",
--                                                                      "patient"."resource",
--                                                                      'subject'
--                                                               )
--                                                               AND "diagnosticreport"."resource" @@ 'not category.#.coding.#(system= "urn:CodeSystem:diagnosticreport-categoryIMI" and (code = "second-result" or code = "consultation-result"))'::jsquery
--                                                               AND diagnosticreport.resource ?? 'radiationDose'
--                                                               AND (
--                                                                      SELECT mkb
--                                                                      FROM UNNEST(
--                                                                                    knife_extract_text (
--                                                                                           sr.resource,
--                                                                                           '[["reasonCode","coding",{"system":"urn:CodeSystem:icd-10"},"code"],["reasonReference","identifier",{"system":"urn:CodeSystem:icd-10"},"value"]]'
--                                                                                    )
--                                                                             ) mkb
--                                                                      WHERE mkb SIMILAR TO 'F%'
--                                                                             OR mkb SIMILAR TO 'F1%'
--                                                                             OR mkb SIMILAR TO '(B2[0-4])%'
--                                                                             OR mkb SIMILAR TO '(A5[0-469]|A6[03]|Z22.[48]|Z11.3|Z71.2|Z86.1|Z20.2|N89|N34.1|B37.3|B37.4)%'
--                                                                             OR mkb SIMILAR TO '(A1[5-9]|B90|R76.1|Z20.1)%'
--                                                                      LIMIT 1
--                                                               ) IS NULL
--                                                        )
--                                                        AND LOWER("patient"."resource"#>>'{name,0,given,0}') = CASE
--                                                               WHEN "diagnosticreport"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                                      SPLIT_PART(
--                                                                             SPLIT_PART(
--                                                                                    "diagnosticreport"."resource"#>>'{subject,display}',
--                                                                                    ',',
--                                                                                    1
--                                                                             ),
--                                                                             ' ',
--                                                                             2
--                                                                      )
--                                                               )
--                                                               ELSE LOWER("patient"."resource"#>>'{name,0,given,0}')
--                                                        END
--                                                        AND COALESCE(
--                                                               LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                               ''
--                                                        ) = CASE
--                                                               WHEN "diagnosticreport"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN LOWER(
--                                                                      SPLIT_PART(
--                                                                             SPLIT_PART(
--                                                                                    "diagnosticreport"."resource"#>>'{subject,display}',
--                                                                                    ',',
--                                                                                    1
--                                                                             ),
--                                                                             ' ',
--                                                                             3
--                                                                      )
--                                                               )
--                                                               ELSE COALESCE(
--                                                                      LOWER("patient"."resource"#>>'{name,0,given,1}'),
--                                                                      ''
--                                                               )
--                                                        END
--                                                        AND CAST("patient"."resource"->>'birthDate' AS "date") = CASE
--                                                               WHEN "diagnosticreport"."resource"#>>'{subject,identifier,value}' = '0000000000000000' THEN TO_DATE(
--                                                                      SPLIT_PART(
--                                                                             "diagnosticreport"."resource"#>>'{subject,display}',
--                                                                             ',',
--                                                                             2
--                                                                      ),
--                                                                      'DD.mm.YYYY'
--                                                               )
--                                                               ELSE CAST("patient"."resource"->>'birthDate' AS "date")
--                                                        END
--                                                 )
--                                          ORDER BY CAST(
--                                                        "diagnosticreport"."resource"#>>'{effective,dateTime}' AS "timestamptz"
--                                                 ) DESC NULLS FIRST
--                                   ) "diagnosticreport_subselect"
--                     ) AS "xRay"
--                     (
--                            SELECT JSON_AGG(ROW_TO_JSON("rmis_semd_document_subselect".*)) AS "rmis_semd_document"
--                            FROM (
--                                          SELECT *,
--                                                 (
--                                                        SELECT JSON_AGG(
--                                                                      ROW_TO_JSON("rmis_semd_document_signature_subselect".*)
--                                                               ) AS "rmis_semd_document_signature"
--                                                        FROM (
--                                                                      SELECT *
--                                                                      FROM "rmis"."semd_document_signature" "sds"
--                                                                      WHERE "sds"."semd_document_id" = "sd"."id"
--                                                               ) "rmis_semd_document_signature_subselect"
--                                                 ) AS "semd_document_signatures",
--                                                 (
--                                                        SELECT ROW_TO_JSON("rmis_semd_document_extension_subselect".*) AS "rmis_semd_document_extension"
--                                                        FROM (
--                                                                      SELECT *
--                                                                      FROM "rmis"."semd_document_extension" "sds"
--                                                                      WHERE "sds"."semd_document_id" = "sd"."id"
--                                                                      LIMIT 1
--                                                               ) "rmis_semd_document_extension_subselect"
--                                                 ) AS "semd_document_extension"
--                                          FROM "rmis"."semd_document" "sd"
--                                          WHERE (
--                                                        "sd"."j_for" @@ logic_revinclude("patient"."resource", "patient"."id")
--                                                        AND in_period_matched_identifier("sd"."cts", "sd"."j_for", "patient"."resource")
--                                                        AND (
--                                                               --                     ("sd"."code_ramd_2_41" IN ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)) 
--                                                               --                      AND
--                                                               "sd"."status" = 'completed'
--                                                        )
--                                                 )
--                                          ORDER BY CAST("sd"."execution_period_start" AS "timestamptz") DESC NULLS LAST
--                                          LIMIT 1
--                                   ) "rmis_semd_document_subselect"
--                     ) AS "medicalReport"
              FROM "patient"
              WHERE "patient"."id" = '4222c96e-5420-4a12-9cb8-ce4127c2f835'
       ) "patient_subselect"
LIMIT 1