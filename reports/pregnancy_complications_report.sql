WITH observations AS (
SELECT
	jsonb_path_query_first(resource, '$.episodeOfCare.identifier') AS eoc_identifier, max(CAST(jsonb_path_query_first(resource, '$ ? (exists (@.category [*] .coding [*] ? (@.system == "urn:CodeSystem:pregnancy" && @.code == "current-pregnancy")) && exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancies"))).value.integer') AS TEXT)) AS pregnancies, max(CAST(jsonb_path_query_first(resource, '$ ? (exists (@.category [*] .coding [*] ? (@.system == "urn:CodeSystem:pregnancy" && @.code == "current-pregnancy")) && exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "birth-number"))).value.integer') AS TEXT)) AS birth_number, max(CAST(jsonb_path_query_first(resource, '$ ? (exists (@.category [*] .coding [*] ? (@.system == "urn:CodeSystem:pregnancy" && @.code == "current-pregnancy")) && exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "newborn-number"))).value.integer') AS TEXT)) AS newborn_number, count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "1").code')) AS delivery_on_time, count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "2").code')) AS premature_birth, count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "3").code')) AS medical_abortion_12_weeks, count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "4").code')) AS abortion_for_medical_reasons, count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "5").code')) AS spontaneous_miscarriage_11_weeks, count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "6").code')) AS spontaneous_miscarriage_12_21_weeks, count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "7").code')) AS unspecified_miscarriage, count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "8").code')) AS delayed_delivery, count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "9").code')) AS frozen_pregnancy, count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "10").code')) AS ectopic_pregnancy, count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:newborn-information" && @.code == "state-after-birth"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:live-state" && @.code == "0").code')) AS newborn, string_agg(jsonb_path_query_first(resource, '$ ? (exists (@.code [*] .coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-number"))).component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-pathology"))).value.string') #>> '{}', ',') AS pathology_of_pregnancy, string_agg(jsonb_path_query_first(resource, '$ ? (exists (@.code [*] .coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-number"))).component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "birth-abortion-pathology"))).value.string') #>> '{}', ',') AS pathology_of_childbirth_abortion
FROM
	observation
WHERE
	resource @@ 'category.#.coding.#(system="urn:CodeSystem:observation-category" and code="pregnancy-information")'::jsquery
GROUP BY
	eoc_identifier
HAVING
	((count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "1").code')) > 0
	AND ((string_agg(jsonb_path_query_first(resource, '$ ? (exists (@.code [*] .coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-number"))).component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-pathology"))).value.string') #>> '{}', ',') IS NOT NULL
	OR string_agg(jsonb_path_query_first(resource, '$ ? (exists (@.code [*] .coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-number"))).component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "birth-abortion-pathology"))).value.string') #>> '{}', ',') IS NOT NULL
	OR string_agg(jsonb_path_query_first(resource, '$ ? (exists (@.code [*] .coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-number"))).component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "aids-surgeries"))).value.string') #>> '{}', ',') IS NOT NULL)
	OR count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:newborn-information" && @.code == "state-after-birth"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:live-state" && @.code == "0").code')) > 0))
	OR count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "2").code')) > 0
	OR count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "3").code')) > 0
	OR count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "4").code')) > 0
	OR count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "5").code')) > 0
	OR count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "6").code')) > 0
	OR count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "7").code')) > 0
	OR count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "8").code')) > 0
	OR count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "9").code')) > 0
	OR count(jsonb_path_query_first(resource, '$.component [*] ? (exists (@.code.coding [*] ? (@.system == "urn:CodeSystem:pregnancy-information" && @.code == "pregnancy-outcome"))).value.CodeableConcept.coding ? (@.system == "urn:CodeSystem:pregnancy-outcome" && @.code == "10").code')) > 0))
SELECT
	eoc.id AS eoc_id
	, obs.*
	, eoc.resource #>> '{managingOrganization,display}' AS org
	, concat(p.resource #>> '{name,0,family}', ' ' , p.resource #>> '{name,0,given,0}', ' ' , p.resource #>> '{name,0,given,1}') AS name
	, p.resource ->> 'birthDate' AS birthdate
	, eoc.resource #>> '{period,start}' AS START
	, risk.resource #>> '{prediction,0,probability,decimal}' AS risk
	, split_part(eoc.resource #>> '{careManager,display}', ';', 1) AS doctor
FROM
	observations obs
INNER JOIN episodeofcare eoc ON
	eoc.resource @@ CAST(concat('identifier.#(system = "', obs.eoc_identifier ->> 'system', '" and value = "', obs.eoc_identifier ->> 'value', '")', ' and type.#.coding.#(system="urn:CodeSystem:episodeofcare-type" and code="PregnantCard")') AS jsquery)
LEFT JOIN patient p ON
	(p.resource @@ logic_include(eoc.resource, 'patient', NULL)
	OR p.id = CAST(jsonb_path_query_first(eoc.resource, '$.patient.id') AS TEXT))
LEFT JOIN riskassessment risk ON
	risk.resource @@ logic_revinclude(eoc.resource, eoc.id, 'episodeOfCare', '  and code.coding.#(system="urn:CodeSystem:pregnancy-risk-type" and code="pregnancy")')
WHERE
	(daterange(CAST(eoc.resource #>> '{period,start}' AS date), CAST(eoc.resource #>> '{period,end}' AS date)) && daterange(CAST('2020-02-10' AS date), CAST('2020-08-10' AS date), '[]')) 
	
	